
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Allow authenticated users to read their own user data
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId;
    }
    
    // Allow authenticated users to read the users collection
    match /users/{document=**} {
      allow read: if isAuthenticated();
    }

    // Allow authenticated users to read and create announcements
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
    }

    // Allow authenticated users to read kpi data
    match /kpi/{kpiId} {
      allow read: if isAuthenticated();
    }

    // Allow authenticated users to read productionStatus
    match /productionStatus/{statusId} {
      allow read: if isAuthenticated();
    }

    // Allow authenticated users to manage payment requests
    match /paymentRequests/{requestId} {
      allow read, update: if isAuthenticated();
      allow create: if isAuthenticated();
    }
    
    // Allow authenticated users to read budget data
    match /budgets/{budgetId} {
        allow read: if isAuthenticated();
    }

    // Allow authenticated users to manage leave requests
    match /leaveRequests/{requestId} {
      allow read, update, create: if isAuthenticated();
    }
    
    match /leaveRequests/{document=**} {
        allow read: if isAuthenticated();
    }

    // Allow users to manage their own permissions document
    match /userPermissions/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }
    
    // Allow Super Admin to manage all permission documents
    match /userPermissions/{userId} {
      allow read, write: if isAuthenticated() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.department == 'Super Admin';
    }

    // Allow authenticated users to create tickets
    match /helpdeskTickets/{ticketId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated();
    }
    
    // Allow authenticated users to manage incidents
    match /incidents/{incidentId} {
        allow create: if isAuthenticated();
        allow read: if isAuthenticated();
    }

    // Allow authenticated users to read inventory
    match /inventory/{itemId} {
      allow read: if isAuthenticated();
    }
    
    // Allow authenticated users to create and read purchase requests
    match /purchaseRequestsSC/{prId} {
        allow read, create: if isAuthenticated();
    }
    
    // Allow authenticated users to read assets
    match /assets/{assetId} {
        allow read, create: if isAuthenticated();
    }
    
    // Allow authenticated users to read maintenance tasks
    match /maintenanceTasks/{taskId} {
      allow read: if isAuthenticated();
    }
    
    // Allow authenticated users to read general ledger entries
    match /generalLedger/{entryId} {
        allow read: if isAuthenticated();
    }
    
    // Allow authenticated users to read invoices
    match /invoices/{invoiceId} {
        allow read: if isAuthenticated();
    }
    
    // Allow authenticated users to read bills
    match /bills/{billId} {
        allow read: if isAuthenticated();
    }

    // Allow authenticated users to read bank accounts
    match /bankAccounts/{accountId} {
        allow read: if isAuthenticated();
    }
    
    // Read-only access for other collections for now
    match /{document=**} {
      allow read: if true;
    }
  }
}
